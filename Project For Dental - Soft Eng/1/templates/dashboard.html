<!DOCTYPE html>
<html>
<head>
    <title>Dashboard - MCVIL DENTAL CLINIC Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <div class="brand-logo">
                    <img src="{{ url_for('static', filename='Logo.jpg') }}" alt="MCVIL DENTAL CLINIC" class="sidebar-logo">
                </div>
                <h1>MCVIL DENTAL CLINIC</h1>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">DISCOVER</div>
                <a href="{{ url_for('dashboard') }}" class="nav-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">INVENTORY</div>
                <a href="{{ url_for('add_item') }}" class="nav-item">
                    <i class="fas fa-plus"></i>
                    Add Item
                </a>
                <a href="{{ url_for('inventory') }}" class="nav-item">
                    <i class="fas fa-boxes"></i>
                    Inventory Items
                </a>
                <a href="{{ url_for('categories') }}" class="nav-item">
                    <i class="fas fa-tags"></i>
                    Categories
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">REPORTS</div>
                <a href="{{ url_for('transactions') }}" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    Transactions
                </a>
                <a href="{{ url_for('reports') }}" class="nav-item">
                    <i class="fas fa-chart-bar"></i>
                    Reports
                </a>
                <a href="{{ url_for('analytics') }}" class="nav-item">
                    <i class="fas fa-chart-line"></i>
                    Analytics
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">SETTINGS</div>
                <a href="{{ url_for('logout') }}" class="nav-item">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Dashboard</h1>
                <div class="header-actions">
                    <div id="notif-container" style="position: relative; margin-right: 16px; cursor: pointer;" title="Low stock notifications">
                        <i class="fas fa-bell"></i>
                        <span id="notif-badge" class="badge badge-danger" style="position:absolute; top:-6px; right:-6px; font-size:10px; padding:2px 6px; display:none;">0</span>
                        <div id="notif-panel" class="content-card" style="display:none; position:absolute; right:0; top:28px; width:260px; z-index:1000;">
                            <div class="content-card-header">
                                <div class="content-card-title">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    Low Stock Items
                                </div>
                            </div>
                            <div class="content-card-body" style="max-height:260px; overflow:auto; padding-top:8px;">
                                <div id="notif-list" class="low-stock-list"></div>
                            </div>
                        </div>
                    </div>
                    <div class="user-profile">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-info">
                            <h4>{{ session.username }}</h4>
                            <p>Administrator</p>
                        </div>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </div>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-success fade-in">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {# Precompute counts for charts #}
            {% set low_stock = 0 %}
            {% for item in items %}
                {% if item[2] <= item[3] %}
                    {% set low_stock = low_stock + 1 %}
                {% endif %}
            {% endfor %}
            {% set well_stocked = items|length - low_stock %}
            <span id="val-well-stocked" data-value="{{ well_stocked }}" style="display:none"></span>
            <span id="val-low-stock" data-value="{{ low_stock }}" style="display:none"></span>
            <span id="val-top" 
                  data-labels='[{% for item in items[:5] %}{{ '"' ~ item[1] ~ '"' }}{% if not loop.last %}, {% endif %}{% endfor %}]' 
                  data-quantities='[{% for item in items[:5] %}{{ item[2] }}{% if not loop.last %}, {% endif %}{% endfor %}]' 
                  style="display:none"></span>

            <!-- Quick Stats -->
            <div class="stats-grid" style="margin-top:16px;">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-title">Total Items</div>
                        <div class="stat-actions">
                            <i class="fas fa-ellipsis-v"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ items|length }}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>All items in inventory</span>
                    </div>
                </div>
            </div>
            
            <!-- Charts moved from Analytics -->
            <div class="analytics-grid" style="margin-top:16px;">
                <div class="content-card fade-in">
                    <div class="content-card-header">
                        <div class="content-card-title">
                            <i class="fas fa-chart-pie"></i>
                            Stock Overview
                        </div>
                    </div>
                    <div class="content-card-body">
                        <canvas id="stockChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <div class="content-card fade-in">
                    <div class="content-card-header">
                        <div class="content-card-title">
                            <i class="fas fa-chart-bar"></i>
                            Top Items by Quantity
                        </div>
                    </div>
                    <div class="content-card-body">
                        <canvas id="quantityChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            initializeCharts();
            
            // Real-time low stock polling
            function updateLowStockBadge(count) {
                const badge = document.getElementById('notif-badge');
                if (!badge) return;
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }

            async function fetchLowStockCount() {
                try {
                    const res = await fetch("{{ url_for('api_low_stock') }}", { cache: 'no-store' });
                    if (!res.ok) return;
                    const data = await res.json();
                    const count = (data && Array.isArray(data.items)) ? data.items.length : 0;
                    updateLowStockBadge(count);
                    renderLowStockList(data.items || []);
                } catch (e) {
                    // ignore
                }
            }

            function renderLowStockList(items) {
                const listEl = document.getElementById('notif-list');
                if (!listEl) return;
                listEl.innerHTML = '';
                if (!items.length) {
                    listEl.innerHTML = '<div style="text-align:center; color: var(--text-secondary); padding: 8px;">No low stock items</div>';
                    return;
                }
                items.forEach(function(item) {
                    const name = item[1];
                    const qty = item[2];
                    const min = item[3];
                    const unit = item[4] || '';
                    const div = document.createElement('div');
                    div.className = 'low-stock-item';
                    div.innerHTML = '<div class="item-info"><h4 style="margin:0; font-size:14px;">' + name + '</h4><p style="margin:2px 0; font-size:12px;">' + qty + ' / ' + min + ' ' + unit + '</p></div><div class="item-status"><span class="badge badge-danger">Low</span></div>';
                    listEl.appendChild(div);
                });
            }

            const notif = document.getElementById('notif-container');
            const panel = document.getElementById('notif-panel');
            if (notif && panel) {
                notif.addEventListener('click', function(e) {
                    e.stopPropagation();
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                });
                document.addEventListener('click', function() {
                    panel.style.display = 'none';
                });
            }

            fetchLowStockCount();
            setInterval(fetchLowStockCount, 10000);
        });
        
        // Initialize charts
        function initializeCharts() {
            // Stock Distribution Chart (Pie Chart)
            const stockCtx = document.getElementById('stockChart').getContext('2d');
            const wellVal = parseInt(document.getElementById('val-well-stocked').dataset.value) || 0;
            const lowVal = parseInt(document.getElementById('val-low-stock').dataset.value) || 0;
            const stockData = {
                labels: ['Well Stocked', 'Low Stock'],
                datasets: [{
                    data: [wellVal, lowVal],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0
                }]
            };
            
            new Chart(stockCtx, {
                type: 'doughnut',
                data: stockData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Top Items by Quantity Chart (Bar Chart)
            const quantityCtx = document.getElementById('quantityChart').getContext('2d');
            const topEl = document.getElementById('val-top');
            const items = JSON.parse(topEl.dataset.labels || '[]');
            const quantities = JSON.parse(topEl.dataset.quantities || '[]');
            
            new Chart(quantityCtx, {
                type: 'bar',
                data: {
                    labels: items,
                    datasets: [{
                        label: 'Quantity',
                        data: quantities,
                        backgroundColor: '#6366f1',
                        borderColor: '#4f46e5',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>


