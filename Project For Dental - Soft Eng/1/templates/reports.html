<!DOCTYPE html>
<html>
<head>
    <title>Reports - MCVIL DENTAL CLINIC Inventory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-brand">
                <div class="brand-logo">
                    <img src="{{ url_for('static', filename='Logo.jpg') }}" alt="MCVIL DENTAL CLINIC" class="sidebar-logo">
                </div>
                <h1>MCVIL DENTAL CLINIC</h1>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">DISCOVER</div>
                <a href="{{ url_for('dashboard') }}" class="nav-item">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">INVENTORY</div>
                <a href="{{ url_for('add_item') }}" class="nav-item">
                    <i class="fas fa-plus"></i>
                    Add Item
                </a>
                <a href="{{ url_for('inventory') }}" class="nav-item">
                    <i class="fas fa-boxes"></i>
                    Inventory Items
                </a>
                <a href="{{ url_for('categories') }}" class="nav-item">
                    <i class="fas fa-tags"></i>
                    Categories
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">REPORTS</div>
                <a href="{{ url_for('transactions') }}" class="nav-item">
                    <i class="fas fa-exchange-alt"></i>
                    Transactions
                </a>
                <a href="{{ url_for('reports') }}" class="nav-item active">
                    <i class="fas fa-chart-bar"></i>
                    Reports
                </a>
            </div>
            
            <div class="nav-section">
                <div class="nav-section-title">SETTINGS</div>
                <a href="{{ url_for('logout') }}" class="nav-item">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Reports & Analytics</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="exportReport()">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                    <button class="btn btn-secondary" onclick="printReport()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
            
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-success fade-in">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-title">Total Items</div>
                        <div class="stat-actions">
                            <i class="fas fa-boxes"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ total_items }}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>All inventory items</span>
                    </div>
                </div>
                
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-title">Low Stock Items</div>
                        <div class="stat-actions">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ low_stock_count }}</div>
                    <div class="stat-change {{ 'negative' if low_stock_count > 0 else 'positive' }}">
                        <i class="fas fa-{{ 'arrow-down' if low_stock_count > 0 else 'check' }}"></i>
                        <span>{{ 'Need attention' if low_stock_count > 0 else 'All good' }}</span>
                    </div>
                </div>
                
                <div class="stat-card fade-in">
                    <div class="stat-header">
                        <div class="stat-title">Categories</div>
                        <div class="stat-actions">
                            <i class="fas fa-tags"></i>
                        </div>
                    </div>
                    <div class="stat-value">{{ category_stats|length }}</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span>Active categories</span>
                    </div>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="analytics-grid">
                <div class="content-card fade-in">
                    <div class="content-card-header">
                        <div class="content-card-title">
                            <i class="fas fa-chart-pie"></i>
                            Items by Category
                        </div>
                    </div>
                    <div class="content-card-body">
                        <canvas id="categoryChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <div class="content-card fade-in">
                    <div class="content-card-header">
                        <div class="content-card-title">
                            <i class="fas fa-chart-bar"></i>
                            Top Items by Quantity
                        </div>
                    </div>
                    <div class="content-card-body">
                        <canvas id="topItemsChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Detailed Reports -->
            <div class="content-card fade-in">
                <div class="content-card-header">
                    <div class="content-card-title">
                        <i class="fas fa-table"></i>
                        Category Breakdown
                    </div>
                </div>
                <div class="content-card-body">
                    {% if category_stats %}
                    <table class="inventory-table">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Item Count</th>
                                <th>Percentage</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in category_stats %}
                            <tr>
                                <td><strong>{{ category[0] }}</strong></td>
                                <td>{{ category[1] }}</td>
                                <td>{{ "%.1f"|format((category[1] / total_items * 100) if total_items > 0 else 0) }}%</td>
                                <td>
                                    <span class="badge badge-success">Active</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                        <div style="text-align:center; padding:2rem; color:var(--text-secondary);">
                            <i class="fas fa-chart-bar" style="font-size:3rem; margin-bottom:1rem; opacity:.5;"></i>
                            <p>No category data available</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Top Items Report -->
            <div class="content-card fade-in">
                <div class="content-card-header">
                    <div class="content-card-title">
                        <i class="fas fa-trophy"></i>
                        Top 10 Items by Quantity
                    </div>
                </div>
                <div class="content-card-body">
                    {% if top_items %}
                    <div class="top-items-list">
                        {% for item in top_items %}
                        <div class="top-item">
                            <div class="item-rank">{{ loop.index }}</div>
                            <div class="item-info">
                                <h4>{{ item[0] }}</h4>
                                <p>{{ item[1] }} units in stock</p>
                            </div>
                            <div class="item-quantity">
                                <span class="quantity-badge">{{ item[1] }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                        <div style="text-align:center; padding:2rem; color:var(--text-secondary);">
                            <i class="fas fa-trophy" style="font-size:3rem; margin-bottom:1rem; opacity:.5;"></i>
                            <p>No items available for ranking</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            initializeCharts();
        });
        
        function initializeCharts() {
            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            const categoryData = {
                labels: [{% for category in category_stats %}'{{ category[0] }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    data: [{% for category in category_stats %}{{ category[1] }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: [
                        '#0ea5e9', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                        '#06b6d4', '#84cc16', '#f97316', '#ec4899', '#6b7280'
                    ],
                    borderWidth: 0
                }]
            };
            
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: categoryData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Top Items Chart
            const topItemsCtx = document.getElementById('topItemsChart').getContext('2d');
            const topItemsData = {
                labels: [{% for item in top_items[:5] %}'{{ item[0] }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                datasets: [{
                    label: 'Quantity',
                    data: [{% for item in top_items[:5] %}{{ item[1] }}{% if not loop.last %}, {% endif %}{% endfor %}],
                    backgroundColor: '#6366f1',
                    borderColor: '#4f46e5',
                    borderWidth: 1
                }]
            };
            
            new Chart(topItemsCtx, {
                type: 'bar',
                data: topItemsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
        
        function exportReport() {
            // Create CSV content
            let csv = 'Inventory Report\n';
            csv += 'Generated on: ' + new Date().toLocaleDateString() + '\n\n';
            csv += 'Category,Item Count,Percentage\n';
            
            {% for category in category_stats %}
            csv += '{{ category[0] }},{{ category[1] }},{{ "%.1f"|format((category[1] / total_items * 100) if total_items > 0 else 0) }}%\n';
            {% endfor %}
            
            exportToCSV(csv, 'inventory_report_' + new Date().toISOString().slice(0,10) + '.csv');
        }
        
        function printReport() {
            printPage();
        }
    </script>
    
    <style>
        .top-items-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .top-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .item-rank {
            width: 32px;
            height: 32px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-info h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .item-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .quantity-badge {
            background: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        @media print {
            .sidebar, .header-actions, .btn {
                display: none !important;
            }
            
            .main-content {
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            .content-card {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
                margin-bottom: 1rem !important;
            }
        }
    </style>
</body>
</html>
